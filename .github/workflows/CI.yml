name: build

on:
  workflow_dispatch:
    inputs:
      rel:
        description: '编译完成后是否发布Release'
        required: true
        default: true
        type: boolean
      tag:
        description: '指定Release的版本号（留空为当天日期）'
        required: false
        default: ''
      upx:
        description: '是否使用upx压缩linux的二进制'
        required: true
        default: true
        type: boolean
      del:
        description: '是否删除历史编译的流程记录'
        required: true
        default: true
        type: boolean

env:
  tag: "${{ github.event.inputs.tag }}"
  rel: "${{ github.event.inputs.rel }}"
  TZ: Asia/Shanghai

permissions:
  contents: write
  actions: write

jobs:
  build:
    name: Build ${{ matrix.target }}
    strategy:
      fail-fast: false
      matrix:
        include:
        - target: aarch64-linux
          os: ubuntu-latest
          URL: aarch64-linux-musl
          
        - target: x86_64-linux
          os: ubuntu-latest
          URL: x86_64-linux-musl
          
        - target: i686-linux
          os: ubuntu-latest
          URL: i686-linux-musl
          
        - target: armv7-linux-eabihf
          os: ubuntu-latest
          URL: armv7l-linux-musleabihf
          
        - target: armv7-linux-eabi
          os: ubuntu-latest
          URL: armv7m-linux-musleabi
          
        - target: arm-linux-eabihf
          os: ubuntu-latest
          URL: arm-linux-musleabihf
          
        - target: arm-linux-eabi
          os: ubuntu-latest
          URL: arm-linux-musleabi
          
        - target: mipsel-linux
          os: ubuntu-latest
          URL: mipsel-linux-muslsf
          
        - target: mips-linux
          os: ubuntu-latest
          URL: mips-linux-muslsf
          
        - target: mips64-linux
          os: ubuntu-latest
          URL: mips-linux-musl
          
        - target: s390x-linux
          os: ubuntu-latest
          URL: s390x-linux-musl
          
        - target: loongarch64-linux
          os: ubuntu-latest
          URL: loongarch64-linux-musl

    runs-on: ${{ matrix.os }}
    steps:
     - name: 检出代码
       uses: actions/checkout@v5
       
     - name: 下载 musl 交叉编译工具链
       uses: lmq8267/dl-musl@main
       with:
        target: ${{ matrix.URL }}
        static: true
        gccpath: /tmp
         
     - name: 编译
       run: |
         make 
         mkdir -p ${{ matrix.target }}
         mv n2n_check_cli ${{ matrix.target }}/n2n_check_cli
         mv n2n_check_http ${{ matrix.target }}/n2n_check_http
       
     - name: 安装 UPX
       if: github.event.inputs.upx == 'true' 
       uses: crazy-max/ghaction-upx@v3
       with:
        version: v4.2.4
        install-only: true
        
     - name: 压缩二进制
       if: github.event.inputs.upx == 'true'
       run: upx --lzma --best ${{ matrix.target }}/* || true
       
     - name: 上传产物
       uses: actions/upload-artifact@v4
       with:
        name: n2n-supernode-monitor-${{ matrix.target }}
        path: ${{ matrix.target }}/*

  release:
    needs: build
    if: github.event.inputs.rel == 'true'
    runs-on: ubuntu-latest
    steps:
     - name: 下载所有构建产物
       uses: actions/download-artifact@v4
       with:
        path: release

     - name: 生成时间与标签
       run: |
          sudo timedatectl set-timezone "Asia/Shanghai"
          echo "build_time=$(date '+%Y年%m月%d日%H:%M:%S' | jq -sRr @uri)" >> $GITHUB_ENV
          if [ -z "${{ env.tag }}" ]; then
              echo "tag=$(date '+%Y-%m-%d')" >> $GITHUB_ENV
          fi

     - name: 打包 zip
       run: |
          mkdir -p out
          find release -type f -exec cp {} out/ \;
          cd out
          zip -j ../n2n-supernode-monitor_${{ matrix.target }}.zip *
          cd ..

     - name: 发布 Release
       uses: softprops/action-gh-release@v2
       with:
          token: ${{ secrets.GITHUB_TOKEN }}
          body: |
           > ### ![](https://img.shields.io/badge/%E7%BC%96%E8%AF%91%E6%97%B6%E9%97%B4-${{ env.build_time }}-8267?logo=github&labelColor=%E9%A1%BB)![](https://img.shields.io/github/downloads/${{ github.repository }}/${{ env.tag }}/total?label=%E4%B8%8B%E8%BD%BD%E6%AC%A1%E6%95%B0&logo=github)
          
          tag_name: ${{ env.tag }}
          files: n2n-supernode-monitor_${{ matrix.target }}.zip

  del:
    runs-on: ubuntu-latest
    steps:
      - name: 删除流程记录
        if: github.event.inputs.del == 'true'
        uses: Mattraks/delete-workflow-runs@main
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          retain_days: 0
          keep_minimum_runs: 0

 
